<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FütPicks</title>
    <link rel="stylesheet" href="teampts.css" />
    <link rel="stylesheet" href="header-temp.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
  </head>
  <body>
    <header>FütPick's Liga MX Fantasy Football</header>
    <h3 id="user-info" style="color: lightgreen; text-align: center"></h3>

    <ul id="navlist">
      <li id="profile"><a href="http://example.com"></a></li>
      <li id="calendar"><a href="http://example.com"></a></li>
    </ul>
    <nav id="subHeader">
      <button><a href="homepage.html">Home</a></button>
      <button><a href="fixtures.html">Fixtures</a></button>
      <button><a href="teampts.html">Points</a></button>
      <button class="active"><a href="teampick.html">Pick Team</a></button>
      <button><a href="transpick.html">Transfers</a></button>
      <button><a href="player_stats.html">Player Stats</a></button>
    </nav>

    <div class="sidebar">
      <button class="league-btn active">LigaMx</button>
      <div class="hudtip">La Liga <span class="hudtext">Coming Soon</span></div>
      <div class="hudtip">
        Premier League <span class="hudtext">Coming Soon</span>
      </div>
      <div class="hudtip">
        Bundesliga <span class="hudtext">Coming Soon</span>
      </div>
    </div>

    <img
      src="images/futpicks-logo.png"
      alt="background image"
      class="center-image"
    />
    <img src="images/fup.png" alt="background image" class="center-image" />

    <nav id="pointHeader">
      <div id="pointStyling">
        <p id="pointCount">46</p>
        <button id="pointText">Average</button>
      </div>
      <div id="pointStyling">
        <p id="pointCount">54</p>
        <button id="userPoints">
          Total Points <i class="arrow right"></i>
        </button>
      </div>
      <div id="pointStyling">
        <p id="pointCount">134</p>
        <button id="highPoints">Highest <i class="arrow right"></i></button>
      </div>
    </nav>

    <div class="team_container">
      <div class="row">
        <div class="gk_column">
          <div class="player_card" id="gk1" data-position="Goalkeeper">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Goalkeeper 1</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="def_column">
          <div class="player_card" id="df1" data-position="Defender">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Defender 1</p>
            </div>
          </div>
          <div class="player_card" id="df2" data-position="Defender">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Defender 2</p>
            </div>
          </div>
          <div class="player_card" id="df3" data-position="Defender">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container" data-position="Defender">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Defender 3</p>
            </div>
          </div>
          <div class="player_card" id="df4" data-position="Defender">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Defender 4</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="mid_column">
          <div class="player_card" id="mf1" data-position="Midfielder">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Midfielder 1</p>
            </div>
          </div>
          <div class="player_card" id="mf2" data-position="Midfielder">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Midfielder 2</p>
            </div>
          </div>
          <div class="player_card" id="mf3" data-position="Midfielder">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Midfielder 3</p>
            </div>
          </div>
          <div class="player_card" id="mf4" data-position="Midfielder">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Midfielder 4</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="fwd_column">
          <div class="player_card" id="fw1" data-position="Attacker">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Forward 1</p>
            </div>
          </div>
          <div class="player_card" id="fw2" data-position="Attacker">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Forward 2</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="reserves_container">
      <div class="row">
        <div class="res_column">
          <div class="player_card" id="res1" data-position="Any">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Reserve 1</p>
            </div>
          </div>
          <div class="player_card" id="res2" data-position="Any">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Reserve 2</p>
            </div>
          </div>
          <div class="player_card" id="res3" data-position="Any">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Reserve 3</p>
            </div>
          </div>
          <div class="player_card" id="res4" data-position="Any">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p class="player-name">Reserve 4</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="playerModal" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modal-title">Select a Player</h2>
        <ul id="player-list"></ul>
      </div>
    </div>

    <div class="save-container">
      <button onclick="saveTeam()">Save Your Team</button>
    </div>

    <div class="footercontainer">
      <div>
        <dl>
          <dt>About</dt>
          <dt><a class="footertext" href="dev-story.html">Our Story</a></dt>
          <dt><a class="footertext" href="contact-us.html">Contact Us</a></dt>
        </dl>
      </div>
      <div>
        <dl>
          <dt>Account</dt>
          <dt><a class="footertext" href="account.html">My Account</a></dt>
          <dt>
            <a class="footertext" href="http://example.com">Reset Password</a>
          </dt>
        </dl>
      </div>
    </div>

    <div id="team-grid" style="display: none"></div>

    <script src="token.js"></script>
    <script>
      // References to UI elements
      const modal = document.getElementById("playerModal");
      const modalTitle = document.getElementById("modal-title");
      const playerList = document.getElementById("player-list");
      const selectedPlayerIds = new Set();
      let selectedCard = null;
      let dataLookup = {};
      let hasUnsavedChanges = false;
      const saveButton = document.querySelector(".save-container button");
      saveButton.disabled = true;

      // Opens the player selection modal
      function openModal(position, card) {
        selectedCard = card;
        const title = position === "Any" ? "Reserve" : position;
        modalTitle.textContent = `Select a ${title}`;
        modal.classList.remove("hidden");
        fetchAndRenderPlayers(position);
      }

      // Closes the player selection modal
      function closeModal() {
        modal.classList.add("hidden");
      }

      // Fetches and displays a list of players for a given position
      async function fetchAndRenderPlayers(position) {
        const res = await fetch("/data/fantasyPlayerPool.json");
        const data = await res.json();
        const players =
          position === "Any" ? Object.values(data).flat() : data[position];

        // Fill global lookup for all players
        players.forEach((p) => (dataLookup[p.id] = p));

        playerList.innerHTML = "";

        players.forEach((p) => {
          const alreadySelected = [
            ...document.querySelectorAll(".player_card"),
          ].some((card) => card.getAttribute("data-player-id") == p.id);
          if (alreadySelected) return;

          const li = document.createElement("li");
          li.innerHTML = `
            <div class="player-list-entry">
              <img src="${p.photo}" class="player-modal-photo" />
              <div class="player-info">
                <strong>${p.name}</strong><br>
                <span class="club-info">${p.team} - ${p.position}</span><br>
                <span class="rating">Rating: ${parseFloat(p.rating).toFixed(
                  1
                )}</span> &nbsp;
                <span class="points">Pts: ${p.points}</span>
              </div>
            </div>
          `;
          li.onclick = () =>
            selectPlayer(p.id, p.name, position, p.photo, p.rating, p.points);
          playerList.appendChild(li);
        });
      }

      // Handles when a user selects a player card from the modal
      function selectPlayer(
        playerId,
        name,
        position,
        photoUrl,
        rating,
        points
      ) {
        hasUnsavedChanges = true;
        saveButton.classList.add("active");
        saveButton.disabled = false;

        const isAlreadySelected = [
          ...document.querySelectorAll(".player_card"),
        ].some((c) => c.getAttribute("data-player-id") == playerId);
        if (isAlreadySelected) {
          alert("Player already selected in another slot!");
          return;
        }

        if (selectedCard) {
          const prevId = selectedCard.getAttribute("data-player-id");
          if (prevId) selectedPlayerIds.delete(parseInt(prevId));

          const img = selectedCard.querySelector("img");
          if (img) {
            img.src = photoUrl || "images/temp_jersey.webp";
            img.alt = name;
          }

          selectedCard.querySelector(".player-name").textContent = name;
          const pointDisplay = selectedCard.querySelector("h2 b");
          if (pointDisplay) pointDisplay.textContent = `${points || 0} pts`;

          selectedCard.setAttribute("data-player-id", playerId);
          selectedPlayerIds.add(playerId);
        }

        closeModal();
      }

      // Clears a player's selection from a card
      function clearPlayer(card) {
        const playerId = card.getAttribute("data-player-id");
        if (playerId) {
          selectedPlayerIds.delete(parseInt(playerId));
          card.removeAttribute("data-player-id");
          card.querySelector("img").src = "images/temp_jersey.webp";
          card.querySelector(".player-name").textContent = "Click to pick";
          card.querySelector("h2 b").textContent = "0 pts";
          hasUnsavedChanges = true;
          saveButton.classList.add("active");
          saveButton.disabled = false;
        }
      }

      // Collects and submits the current team to the backend
      async function saveTeam() {
        const allCards = document.querySelectorAll(".player_card");
        const players = [];

        allCards.forEach((card) => {
          const playerId = card.getAttribute("data-player-id");
          const isReserve = card.id.startsWith("res");
          let position = card.dataset.position;

          if (!playerId) return;

          // Ensure position fallback via lookup
          if (!position || position === "Any") {
            const fromLookup = dataLookup[playerId];
            if (fromLookup && fromLookup.position) {
              position = fromLookup.position;
            } else {
              console.warn("Missing position for player", playerId);
              return;
            }
          }

          players.push({
            player_id: parseInt(playerId),
            position,
            is_reserve: isReserve,
          });
        });

        // Check for complete team
        if (players.length < 15) {
          console.warn("Expected 15 players, got:", players.length);
          alert("Your team must include 15 players.");
          return;
        }

        // Submit to API
        const token = localStorage.getItem("token");
        let headers = { "Content-Type": "application/json" };
        if (token) headers["Authorization"] = `Bearer ${token}`;

        let teamId;

        try {
          const response = await fetch("/api/football/my-team", {
            credentials: "include",
          });
          const data = await response.json();
          teamId = data.teamId;
        } catch (err) {
          console.warn("No existing team found. Creating new one...");
        }

        let endpoint = teamId
          ? "/api/football/update-team"
          : "/api/football/create-team";

        let method = teamId ? "PUT" : "POST";

        const res = await fetch(endpoint, {
          method,
          headers,
          credentials: "include",
          body: JSON.stringify(teamId ? { teamId, players } : { players }),
        });

        const result = await res.json();
        alert(result.message || "Team saved");

        hasUnsavedChanges = false;
        saveButton.classList.remove("active");
        saveButton.disabled = true;
      }

      // Gets the ID of the next empty slot for the player's position
      function getSlotId(p) {
        if (p.is_reserve) {
          for (let i = 1; i <= 4; i++) {
            const card = document.getElementById(`res${i}`);
            if (card && !card.getAttribute("data-player-id")) return card.id;
          }
          return "";
        }

        const map = {
          Goalkeeper: "gk",
          Defender: "df",
          Midfielder: "mf",
          Attacker: "fw",
        };

        const base = map[p.position];
        for (let i = 1; i <= 5; i++) {
          const card = document.getElementById(`${base}${i}`);
          if (card && !card.getAttribute("data-player-id"))
            return `${base}${i}`;
        }
        return "";
      }

      // Loads the saved team from the backend and populates the UI
      function loadSavedTeam() {
        fetch("/api/football/my-team", { credentials: "include" })
          .then((res) => res.json())
          .then((data) => {
            if (!data.players) return;

            data.players.forEach((p) => {
              dataLookup[p.player_id] = {
                id: p.player_id,
                name: p.name,
                position: p.position,
                photo: p.photo,
                points: p.points,
                rating: p.rating,
                team: p.team || "Unknown",
              };

              const slotId = getSlotId(p);
              if (!slotId) {
                console.warn(
                  "No slot found for:",
                  p.name,
                  "Position:",
                  p.position
                );
                return;
              }

              const card = document.getElementById(slotId);
              const img = card.querySelector("img");
              const nameP = card.querySelector(".player-name");
              const pointDisplay = card.querySelector("h2 b");

              if (img) img.src = p.photo || "images/temp_jersey.webp";
              if (nameP) nameP.textContent = p.name;
              if (pointDisplay)
                pointDisplay.textContent = `${p.points || 0} pts`;

              card.setAttribute("data-player-id", p.player_id);
              selectedPlayerIds.add(p.player_id);
            });
          })
          .catch((err) => {
            console.error("Failed to load team:", err);
          });
      }

      // Initializes event listeners and loads saved team on page load
      window.onload = () => {
        const cards = document.querySelectorAll(".player_card");
        cards.forEach((card) => {
          const position = card.dataset.position || "Any";
          card.onclick = () => openModal(position, card);
          card.oncontextmenu = (e) => {
            e.preventDefault();
            clearPlayer(card);
          };
        });

        loadSavedTeam();
      };
    </script>
  </body>
</html>
