<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FütPicks</title>
    <link rel="stylesheet" href="teampts.css" />
    <link rel="stylesheet" href="header-temp.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
  </head>
  <body>
    <header>FütPick's Liga MX Fantasy Football</header>
    <h3 id="user-info" style="color: lightgreen; text-align: center"></h3>

    <ul id="navlist">
      <li id="profile"><a href="http://example.com"></a></li>
      <li id="calendar"><a href="http://example.com"></a></li>
    </ul>
    <nav id="subHeader">
      <button><a href="homepage.html">Home</a></button>
      <button><a href="fixtures.html">Fixtures</a></button>
      <button><a href="teampts.html">Points</a></button>
      <button class="active"><a href="teampick.html">Pick Team</a></button>
      <button><a href="transpick.html">Transfers</a></button>
      <button><a href="player_stats.html">Player Stats</a></button>
    </nav>

    <div class="sidebar">
      <button class="league-btn active">LigaMx</button>
      <button class="league-btn">La Liga</button>
      <button class="league-btn">Premier League</button>
      <button class="league-btn">Bundesliga</button>
    </div>

    <img src="images/fup.png" alt="background image" class="center-image" />

    <nav id="pointHeader">
      <div id="pointStyling">
        <p id="pointCount">0</p>
        <button id="pointText">Average</button>
      </div>
      <div id="pointStyling">
        <p id="pointCount">0</p>
        <button id="userPoints">
          Total Points <i class="arrow right"></i>
        </button>
      </div>
      <div id="pointStyling">
        <p id="pointCount">0</p>
        <button id="highPoints">Highest <i class="arrow right"></i></button>
      </div>
    </nav>

    <div class="team_container">
      <div class="row">
        <div class="gk_column">
          <div class="player_card" data-position="Goalkeeper">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Goalkeeper 1</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="def_column">
          <div class="player_card" data-position="Defender">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Defender 1</p>
            </div>
          </div>
          <div class="player_card" data-position="Defender">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Defender 2</p>
            </div>
          </div>
          <div class="player_card" data-position="Defender">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container" data-position="Defender">
              <h2><b> 0 pts </b></h2>
              <p>Defender 3</p>
            </div>
          </div>
          <div class="player_card" data-position="Defender">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Defender 4</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="mid_column">
          <div class="player_card" data-position="Midfielder">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Midfielder 1</p>
            </div>
          </div>
          <div class="player_card" data-position="Midfielder">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Midfielder 2</p>
            </div>
          </div>
          <div class="player_card" data-position="Midfielder">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Midfielder 3</p>
            </div>
          </div>
          <div class="player_card" data-position="Midfielder">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Midfielder 4</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="fwd_column">
          <div class="player_card" data-position="Attacker">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Forward 1</p>
            </div>
          </div>
          <div class="player_card" data-position="Attacker">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Forward 2</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="reserves_container">
      <div class="row">
        <div class="res_column">
          <div class="player_card" data-position="Any">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Reserve 1</p>
            </div>
          </div>
          <div class="player_card" data-position="Any">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Reserve 2</p>
            </div>
          </div>
          <div class="player_card" data-position="Any">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Reserve 3</p>
            </div>
          </div>
          <div class="player_card" data-position="Any">
            <img
              src="images/temp_jersey.webp"
              alt="Jersey"
              style="width: 70%"
            />
            <div class="player_container">
              <h2><b> 0 pts </b></h2>
              <p>Reserve 4</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="playerModal" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modal-title">Select a Player</h2>
        <ul id="player-list"></ul>
      </div>
    </div>

    <div class="footercontainer">
      <div>
        <dl>
          <dt>About</dt>
          <dt><a class="footertext" href="dev-story.html">Our Story</a></dt>
          <dt>
            <a class="footertext" href="http://example.com">Contact Us</a>
          </dt>
        </dl>
      </div>
      <div>
        <dl>
          <dt>Account</dt>
          <dt><a class="footertext" href="account.html">My Account</a></dt>
          <dt>
            <a class="footertext" href="http://example.com">Reset Password</a>
          </dt>
        </dl>
      </div>
    </div>

    <script src="token.js"></script>
    <script>
      const token = localStorage.getItem("token");
      let headers = { "Content-Type": "application/json" };

      //If token exits, attach to request
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

      let selectedCard = null;

      function openModal(position, card) {
        console.log("Opening modal for:", position);
        selectedCard = card;
        document.getElementById(
          "modal-title"
        ).textContent = `Select a ${position}`;
        document.getElementById("player-list").innerHTML =
          "<li>Loading...</li>";
        document.getElementById("playerModal").classList.remove("hidden");
        fetchPlayers(position);
      }

      function closeModal() {
        document.getElementById("playerModal").classList.add("hidden");
      }

      async function fetchPlayers(position) {
        let allPlayers = [];
        let page = 1;
        let hasMore = true;

        while (hasMore && page <= 5) {
          // Limit to 5 pages max to avoid overloading
          try {
            const res = await fetch(
              `http://localhost:3000/api/football/players?page=${page}`,
              {
                method: "GET",
                headers,
              }
            );

            const data = await res.json();

            if (res.ok && Array.isArray(data.response)) {
              allPlayers.push(...data.response);
              if (data.response.length === 0) {
                hasMore = false;
              } else {
                page++;
              }
            } else {
              console.warn("No player data on page", page);
              hasMore = false;
            }
          } catch (error) {
            console.error("Error fetching players on page", page, error);
            hasMore = false;
          }
        }

        console.log("All players:", allPlayers);

        console.log(
          "Fetched players:",
          allPlayers.map((p) => ({
            name: p.player.name,
            position: p.statistics?.[0]?.games?.position,
          }))
        );

        // Filter players by position unless it's "Any" (for reserves)
        const filtered =
          position === "Any"
            ? allPlayers
            : allPlayers.filter(
                (p) =>
                  p.statistics?.[0]?.games?.position?.toLowerCase() ===
                  position.toLowerCase()
              );

        const list = document.getElementById("player-list");
        list.innerHTML = "";

        if (filtered.length === 0) {
          list.innerHTML = "<li>No players available for this position.</li>";
          return;
        }

        filtered.forEach((p) => {
          const item = document.createElement("li");
          item.textContent = p.player.name;
          item.onclick = () =>
            selectPlayer(p.player.id, p.player.name, position);
          list.appendChild(item);
        });
      }

      function selectPlayer(playerId, name, position) {
        if (selectedCard) {
          selectedCard.querySelector("p").textContent = name;
          selectedCard.querySelector("img").src =
            "https://media.api-sports.io/football/players/placeholder.png";
          // You can store playerId/position into the card as dataset or global array for later saving
        }

        closeModal();
      }

      function initCardClicks() {
        const cards = document.querySelectorAll(".player_card");
        console.log("Found cards:", cards.length);

        cards.forEach((card) => {
          const label = card.querySelector("p")?.textContent.trim();
          let position = card.dataset.position || "";

          if (!position && label) {
            position = label.replace(/[0-9]/g, "").trim(); // fallback
          }

          card.addEventListener("click", () => {
            console.log("Clicked card:", position);
            openModal(position, card);
          });
        });
      }

      // Wait for DOM to fully load before binding clicks
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM fully loaded");
        initCardClicks();
      });
    </script>
  </body>
</html>
